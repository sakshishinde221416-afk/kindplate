{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receiver Dashboard - KindPlate</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    <nav class="navbar">
        <div class="logo-section">
            <span class="logo">KP</span>
            <span class="logo-text">KindPlate</span>
        </div>
        <div class="nav-buttons">
            <button id="themeToggle" class="theme-toggle">üåô</button>
            <span style="color: var(--text-color);">Welcome, {{ user.full_name }}</span>
            <div class="notification-bell" onclick="toggleNotifications()">
                üîî
                {% if notifications_count > 0 %}
                <span class="notification-badge">{{ notifications_count }}</span>
                {% endif %}
            </div>
            <a href="{% url 'logout' %}" class="btn btn-secondary">Logout</a>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <div>
                <h1><span class="dashboard-title-icon">üéÅ</span> Receiver Dashboard</h1>
                <span class="welcome-badge">Welcome back, {{ user.full_name }}!</span>
            </div>
            <div class="dashboard-actions">
                <div class="notification-bell" onclick="toggleNotifications()">
                    üîî
                    {% if notifications_count > 0 %}
                    <span class="notification-badge">{{ notifications_count }}</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-card-icon">üçΩÔ∏è</div>
                <div class="stat-card-value">{{ donations.count }}</div>
                <div class="stat-card-label">Available Donations</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-icon">üì®</div>
                <div class="stat-card-value">{{ requested_donation_ids|length }}</div>
                <div class="stat-card-label">My Requests</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-icon">üíö</div>
                <div class="stat-card-value">Active</div>
                <div class="stat-card-label">Account Status</div>
            </div>
        </div>

        <!-- Search and Filter Section -->
        <div class="search-filter-section">
            <h2 class="section-title">
                <span class="section-title-icon">üîç</span> Find Donations
            </h2>
            
            <form method="GET" class="filter-form">
                <div class="filter-row">
                    <div class="filter-group">
                        <input type="text" name="search" placeholder="üîç Search by food name, location..." value="{{ search_query }}" class="filter-input">
                    </div>
                    
                    <div class="filter-group">
                        <select name="category" class="filter-select">
                            <option value="">All Categories</option>
                            {% for value, label in categories %}
                            <option value="{{ value }}" {% if category_filter == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <select name="expiry" class="filter-select">
                            <option value="">Any Expiry</option>
                            <option value="today" {% if expiry_filter == 'today' %}selected{% endif %}>Expires Today</option>
                            <option value="week" {% if expiry_filter == 'week' %}selected{% endif %}>Within 7 Days</option>
                            <option value="month" {% if expiry_filter == 'month' %}selected{% endif %}>Within 30 Days</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary filter-btn">Apply Filters</button>
                    <a href="{% url 'receiver_dashboard' %}" class="btn btn-secondary filter-btn">Clear</a>
                </div>
            </form>
        </div>

        <h2 class="section-title">
            <span class="section-title-icon">üçΩÔ∏è</span> Available Donations
        </h2>
        
        <div class="donations-grid">
            {% for donation in donations %}
            <div class="donation-card">
                {% if donation.food_image %}
                <div class="donation-image">
                    <img src="{{ donation.food_image.url }}" alt="{{ donation.food_title }}">
                </div>
                {% endif %}
                
                <div class="donation-category-badge">{{ donation.get_category_display }}</div>
                
                <h3><span class="donation-card-icon">üç±</span> {{ donation.food_title }}</h3>
                <p><strong>üìù Description:</strong> {{ donation.description }}</p>
                <p><strong>üìä Quantity:</strong> {{ donation.quantity }}</p>
                <p><strong>üìç Location:</strong> {{ donation.pickup_location }}</p>
                <p><strong>‚è∞ Expires:</strong> {{ donation.expiry_date|date:"M d, Y" }}</p>
                {% if donation.pickup_time_start and donation.pickup_time_end %}
                <p><strong>üïê Pickup Time:</strong> {{ donation.pickup_time_start|time:"g:i A" }} - {{ donation.pickup_time_end|time:"g:i A" }}</p>
                {% endif %}
                <p><strong>üë§ Donor:</strong> {{ donation.donor.full_name }}</p>
                <p><strong>üìÖ Posted:</strong> {{ donation.created_at|date:"M d, Y" }}</p>
                
                {% if donation.id in requested_donation_ids %}
                <button class="btn btn-requested" disabled>‚úì Already Requested</button>
                {% else %}
                <button class="btn btn-primary" onclick="openRequestModal({{ donation.id }}, '{{ donation.food_title|escapejs }}')">üì® Request Food</button>
                {% endif %}
            </div>
            {% empty %}
            <div class="empty-state" style="grid-column: 1 / -1;">
                <div class="empty-state-icon">üîç</div>
                <h3>No Donations Found</h3>
                <p>{% if search_query or category_filter or expiry_filter %}Try adjusting your filters{% else %}Check back soon! New donations are added regularly by our generous donors.{% endif %}</p>
            </div>
            {% endfor %}
        </div>
        
        <!-- Approved Requests with Contact Info -->
        {% if approved_requests %}
        <h2 class="section-title" style="margin-top: 3rem;">
            <span class="section-title-icon">‚úÖ</span> Approved Requests - Contact Information
        </h2>
        <div class="contact-info-section">
            {% for request in approved_requests %}
            <div class="contact-card">
                <h3>{{ request.donation.food_title }}</h3>
                <div class="contact-details">
                    <p><strong>üë§ Donor:</strong> {{ request.donation.donor.full_name }}</p>
                    <p><strong>üìß Email:</strong> <a href="mailto:{{ request.donation.donor.email }}">{{ request.donation.donor.email }}</a></p>
                    {% if request.donation.donor.phone_number %}
                    <p><strong>üìû Phone:</strong> <a href="tel:{{ request.donation.donor.phone_number }}">{{ request.donation.donor.phone_number }}</a></p>
                    {% endif %}
                    <p><strong>üìç Pickup:</strong> {{ request.donation.pickup_location }}</p>
                    {% if request.donation.pickup_time_start and request.donation.pickup_time_end %}
                    <p><strong>üïê Time:</strong> {{ request.donation.pickup_time_start|time:"g:i A" }} - {{ request.donation.pickup_time_end|time:"g:i A" }}</p>
                    {% endif %}
                    {% if request.notes %}
                    <p><strong>üìù Your Note:</strong> {{ request.notes }}</p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- Request Modal -->
    <div class="modal" id="requestModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeRequestModal()">&times;</span>
            <h2>Request Food</h2>
            <p id="modalFoodTitle" style="color: var(--primary-color); font-weight: 600; margin-bottom: 1.5rem;"></p>
            
            <div class="form-group">
                <label for="requestNotes">Add a Note (Optional)</label>
                <textarea id="requestNotes" placeholder="e.g., Family size, urgency, special requirements..." rows="4"></textarea>
                <small class="form-hint">Help the donor understand your situation better</small>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="submitRequest()">Send Request</button>
                <button class="btn btn-secondary" onclick="closeRequestModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="notification-panel" id="notificationPanel">
        <div class="notification-header">
            <h2>My Requests</h2>
            <span class="close-panel" onclick="toggleNotifications()">‚úï</span>
        </div>
        <div id="notificationsList">
            {% for notification in notifications %}
            <div class="notification-item">
                <p><strong>{{ notification.donation.food_title }}</strong></p>
                <p style="font-size: 0.9rem; color: var(--text-secondary);">{{ notification.updated_at|date:"M d, Y H:i" }}</p>
                <span class="status-badge status-{{ notification.status }}">{{ notification.get_status_display }}</span>
                {% if notification.notes %}
                <p style="font-size: 0.85rem; margin-top: 0.5rem;"><em>Your note: {{ notification.notes }}</em></p>
                {% endif %}
            </div>
            {% empty %}
            <p style="color: var(--text-secondary);">No new notifications</p>
            {% endfor %}
        </div>
    </div>

    <footer class="footer">
        <div class="footer-container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>KindPlate</h3>
                    <p>We're here to help you find the assistance you need.</p>
                    <div class="footer-social">
                        <a href="#" class="social-link">Facebook</a>
                        <a href="#" class="social-link">Twitter</a>
                        <a href="#" class="social-link">Instagram</a>
                    </div>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul class="footer-links-list">
                        <li><a href="{% url 'receiver_dashboard' %}">Dashboard</a></li>
                        <li><a href="#">My Requests</a></li>
                        <li><a href="#">Support</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Support</h3>
                    <ul class="footer-links-list">
                        <li><a href="#">Help Center</a></li>
                        <li><a href="#">Guidelines</a></li>
                        <li><a href="#">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Contact</h3>
                    <p>support@kindplate.com</p>
                    <p>+1 (555) 123-4567</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>¬© 2026 KindPlate. All rights reserved.</p>
                <div class="footer-bottom-links">
                    <a href="#">Privacy</a>
                    <a href="#">Terms</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        let currentDonationId = null;
        
        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            panel.classList.toggle('active');
            
            // Mark notifications as read when panel is opened
            if (panel.classList.contains('active')) {
                markNotificationsAsRead();
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function markNotificationsAsRead() {
            fetch('/mark-notifications-read/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update badge with remaining unread count
                    const badges = document.querySelectorAll('.notification-badge');
                    badges.forEach(badge => {
                        if (data.unread_count > 0) {
                            badge.textContent = data.unread_count;
                        } else {
                            badge.style.display = 'none';
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Error marking notifications as read:', error);
            });
        }

        function openRequestModal(donationId, foodTitle) {
            currentDonationId = donationId;
            document.getElementById('modalFoodTitle').textContent = foodTitle;
            document.getElementById('requestNotes').value = '';
            document.getElementById('requestModal').style.display = 'flex';
        }

        function closeRequestModal() {
            document.getElementById('requestModal').style.display = 'none';
            currentDonationId = null;
        }

        function submitRequest() {
            const notes = document.getElementById('requestNotes').value;
            
            fetch(`/request-donation/${currentDonationId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ notes: notes })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.success) {
                    closeRequestModal();
                    location.reload();
                }
            })
            .catch(error => {
                alert('Error sending request. Please try again.');
                console.error('Error:', error);
            });
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('requestModal');
            if (event.target == modal) {
                closeRequestModal();
            }
        }
    </script>

    <script src="{% static 'js/theme.js' %}"></script>
</body>
</html>
