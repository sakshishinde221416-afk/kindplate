{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donor Dashboard - KindPlate</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    <nav class="navbar">
        <div class="logo-section">
            <span class="logo">KP</span>
            <span class="logo-text">KindPlate</span>
        </div>
        <div class="nav-buttons">
            <button id="themeToggle" class="theme-toggle">üåô</button>
            <span style="color: var(--text-color);">Welcome, {{ user.full_name }}</span>
            <a href="{% url 'logout' %}" class="btn btn-secondary">Logout</a>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <div>
                <h1><span class="dashboard-title-icon">üéØ</span> Donor Dashboard</h1>
                <span class="welcome-badge">Welcome back, {{ user.full_name }}!</span>
            </div>
            <div class="dashboard-actions">
                <div class="notification-bell" onclick="toggleNotifications()">
                    üîî
                    {% if notifications_count > 0 %}
                    <span class="notification-badge">{{ notifications_count }}</span>
                    {% endif %}
                </div>
                <a href="{% url 'add_donation' %}" class="btn btn-primary" style="background: white; color: var(--primary-color); font-weight: 600;">+ Add Donation</a>
            </div>
        </div>

        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-card-icon">üì¶</div>
                <div class="stat-card-value">{{ donations.count }}</div>
                <div class="stat-card-label">Total Donations</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-icon">‚è≥</div>
                <div class="stat-card-value">{{ notifications_count }}</div>
                <div class="stat-card-label">Pending Requests</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-icon">üíö</div>
                <div class="stat-card-value">Active</div>
                <div class="stat-card-label">Account Status</div>
            </div>
        </div>

        <h2 class="section-title">
            <span class="section-title-icon">üì¶</span> My Donations
        </h2>
        <div class="donations-grid">
            {% for donation in donations %}
            <div class="donation-card" id="donation-{{ donation.id }}">
                {% if donation.food_image %}
                <div class="donation-image">
                    <img src="{{ donation.food_image.url }}" alt="{{ donation.food_title }}">
                </div>
                {% endif %}
                
                <div class="donation-category-badge">{{ donation.get_category_display }}</div>
                
                <h3><span class="donation-card-icon">üç±</span> {{ donation.food_title }}</h3>
                <p><strong>üìù Description:</strong> {{ donation.description }}</p>
                <p><strong>üìä Quantity:</strong> {{ donation.quantity }}</p>
                <p><strong>üìç Location:</strong> {{ donation.pickup_location }}</p>
                <p><strong>‚è∞ Expires:</strong> {{ donation.expiry_date|date:"M d, Y" }}</p>
                {% if donation.pickup_time_start and donation.pickup_time_end %}
                <p><strong>üïê Pickup Time:</strong> {{ donation.pickup_time_start|time:"g:i A" }} - {{ donation.pickup_time_end|time:"g:i A" }}</p>
                {% endif %}
                <p><strong>üìÖ Posted:</strong> {{ donation.created_at|date:"M d, Y" }}</p>
                <span class="donation-badge">‚úì Active</span>
                
                <div class="donation-actions">
                    <a href="{% url 'edit_donation' donation.id %}" class="btn btn-edit">
                        <span>‚úèÔ∏è</span> Edit
                    </a>
                    <button class="btn btn-delete" onclick="deleteDonation({{ donation.id }})">
                        <span>üóëÔ∏è</span> Delete
                    </button>
                </div>
            </div>
            {% empty %}
            <div class="empty-state" style="grid-column: 1 / -1;">
                <div class="empty-state-icon">üì≠</div>
                <h3>No Donations Yet</h3>
                <p>Start making a difference by adding your first donation!</p>
                <a href="{% url 'add_donation' %}" class="btn btn-primary">Add Your First Donation</a>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="notification-panel" id="notificationPanel">
        <div class="notification-header">
            <h2>Requests</h2>
            <span class="close-panel" onclick="toggleNotifications()">‚úï</span>
        </div>
        <div id="notificationsList">
            {% for request in pending_requests %}
            <div class="notification-item" id="request-{{ request.id }}">
                <p><strong>{{ request.receiver.full_name }}</strong> requested:</p>
                <p style="color: var(--primary-color);">{{ request.donation.food_title }}</p>
                <p style="font-size: 0.9rem; color: var(--text-secondary);">{{ request.created_at|date:"M d, Y H:i" }}</p>
                {% if request.notes %}
                <div style="background: var(--bg-color); padding: 0.8rem; border-radius: 8px; margin: 0.8rem 0; border-left: 3px solid var(--primary-color);">
                    <p style="font-size: 0.85rem; margin: 0;"><strong>üìù Note:</strong></p>
                    <p style="font-size: 0.9rem; margin: 0.3rem 0 0 0;">{{ request.notes }}</p>
                </div>
                {% endif %}
                <div style="background: var(--card-bg); padding: 0.8rem; border-radius: 8px; margin: 0.8rem 0;">
                    <p style="font-size: 0.85rem; margin: 0.3rem 0;"><strong>üìß</strong> {{ request.receiver.email }}</p>
                    {% if request.receiver.phone_number %}
                    <p style="font-size: 0.85rem; margin: 0.3rem 0;"><strong>üìû</strong> {{ request.receiver.phone_number }}</p>
                    {% endif %}
                </div>
                <div class="notification-actions">
                    <button class="btn btn-approve" onclick="updateRequestStatus({{ request.id }}, 'approved')">Approve</button>
                    <button class="btn btn-reject" onclick="updateRequestStatus({{ request.id }}, 'rejected')">Reject</button>
                </div>
            </div>
            {% empty %}
            <p style="color: var(--text-secondary);">No pending requests</p>
            {% endfor %}
        </div>
    </div>

    <script>
        function toggleNotifications() {
            document.getElementById('notificationPanel').classList.toggle('active');
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function updateRequestStatus(requestId, status) {
            fetch(`/update-request/${requestId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ status: status })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`request-${requestId}`).remove();
                    alert(data.message);
                    location.reload();
                } else {
                    alert(data.message);
                }
            });
        }

        function deleteDonation(donationId) {
            if (!confirm('‚ö†Ô∏è Are you sure you want to delete this donation? This action cannot be undone.')) {
                return;
            }

            fetch(`/donor/delete-donation/${donationId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const donationCard = document.getElementById(`donation-${donationId}`);
                    donationCard.style.opacity = '0';
                    donationCard.style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        donationCard.remove();
                        alert(data.message);
                        location.reload();
                    }, 300);
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                alert('Error deleting donation. Please try again.');
                console.error('Error:', error);
            });
        }
    </script>

    <footer class="footer">
        <div class="footer-container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>KindPlate</h3>
                    <p>Thank you for being a donor and making a difference.</p>
                    <div class="footer-social">
                        <a href="#" class="social-link">Facebook</a>
                        <a href="#" class="social-link">Twitter</a>
                        <a href="#" class="social-link">Instagram</a>
                    </div>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul class="footer-links-list">
                        <li><a href="{% url 'donor_dashboard' %}">Dashboard</a></li>
                        <li><a href="{% url 'add_donation' %}">Add Donation</a></li>
                        <li><a href="#">Support</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Support</h3>
                    <ul class="footer-links-list">
                        <li><a href="#">Help Center</a></li>
                        <li><a href="#">Guidelines</a></li>
                        <li><a href="#">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Contact</h3>
                    <p>support@kindplate.com</p>
                    <p>+1 (555) 123-4567</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>¬© 2026 KindPlate. All rights reserved.</p>
                <div class="footer-bottom-links">
                    <a href="#">Privacy</a>
                    <a href="#">Terms</a>
                </div>
            </div>
        </div>
    </footer>

    <script src="{% static 'js/theme.js' %}"></script>
</body>
</html>
